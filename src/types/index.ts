// ============================================================================
// SUPABASE DATABASE TYPES (Generated by Supabase CLI)
// ============================================================================
import type { Database } from './supabase';

export type Business = Database['public']['Tables']['businesses']['Row'];
export type Customer = Database['public']['Tables']['customers']['Row'];
export type WaitlistEntry = Database['public']['Tables']['waitlist_entries']['Row'];
export type Zone = Database['public']['Tables']['zones']['Row'];
export type Table = Database['public']['Tables']['tables']['Row'];

export type WaitlistStatus = 'WAITING' | 'NOTIFIED' | 'ARRIVED' | 'SEATED' | 'CANCELLED' | 'NO_SHOW';

// ============================================================================
// REQUEST/RESPONSE TYPES
// ============================================================================

export interface ChatRequest {
  phone: string;
  message: string;
  businessId: string;
  context?: BusinessContext;
}

export interface ChatResponse {
  response: string;
  actions: Action[];
  confidence: number;
}

export interface IntentRequest {
  message: string;
  context?: Partial<BusinessContext>;
}

export interface IntentResponse {
  intent: IntentType;
  entities: Record<string, any>;
  confidence: number;
}

export interface BatchRequest {
  messages: Array<{
    phone: string;
    message: string;
    businessId: string;
    context?: BusinessContext;
  }>;
}

export interface BatchResponse {
  results: Array<{
    index: number;
    success: boolean;
    data?: ChatResponse;
    error?: string;
  }>;
  processedCount: number;
  failedCount: number;
}

export interface HealthResponse {
  status: 'healthy' | 'degraded' | 'unhealthy';
  ollama: boolean;
  redis: boolean;
  model: string;
  uptime: number;
  timestamp: string;
}

// Action Types
export type ActionType = 
  | 'REGISTER' 
  | 'CHECK_STATUS' 
  | 'CONFIRM_ARRIVAL' 
  | 'CANCEL' 
  | 'INFO_REQUEST'
  | 'UNKNOWN';

export interface Action {
  type: ActionType;
  data: Record<string, any>;
  confidence?: number;
}

// Agent System Types
export interface AgentActionDefinition {
  type: string;
  keywords: string[];
  description: string;
  priority?: number;
}

export interface AgentConfig {
  id: string;
  name: string;
  description: string;
  model: string;
  systemPrompt: string;
  actions?: AgentActionDefinition[];
  temperature?: number;
  maxTokens?: number;
  enabled?: boolean;
}

export interface AgentResponse {
  response: string;
  action?: string | null;
  conversationId?: string;
  agent: {
    id: string;
    name: string;
  };
  tokenCount?: number;
  processingTime?: number;
}

export interface AgentListItem {
  id: string;
  name: string;
  description: string;
  enabled: boolean;
  actions?: Array<{
    type: string;
    description: string;
  }>;
}

// Intent Types
export type IntentType =
  | 'register'
  | 'query_status'
  | 'confirm_arrival'
  | 'cancel'
  | 'request_info'
  | 'general_question'
  | 'greeting'
  | 'unknown';

// Business Context
export interface BusinessContext {
  businessName: string;
  businessAddress?: string;
  businessHours?: string;
  currentWaitlist: number;
  averageWaitTime: number;
  customerInfo?: CustomerInfo;
  additionalInfo?: Record<string, any>;
}

export interface CustomerInfo {
  isKnown: boolean;
  name?: string;
  previousVisits?: number;
  lastVisit?: string;
  preferences?: string[];
}

// Conversation Types
export interface ConversationMessage {
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: number;
}

export interface ConversationHistory {
  phone: string;
  messages: ConversationMessage[];
  lastUpdated: number;
}

// Ollama Types
export interface OllamaMessage {
  role: 'system' | 'user' | 'assistant';
  content: string;
}

export interface OllamaRequest {
  model: string;
  messages: OllamaMessage[];
  stream?: boolean;
  options?: {
    temperature?: number;
    top_p?: number;
    max_tokens?: number;
  };
}

export interface OllamaResponse {
  model: string;
  message: {
    role: string;
    content: string;
  };
  done: boolean;
  total_duration?: number;
  load_duration?: number;
  prompt_eval_count?: number;
  eval_count?: number;
}

// Error Types
export interface ApiError {
  code: string;
  message: string;
  details?: any;
}

// Cache Types
export interface CachedBusinessContext extends BusinessContext {
  cachedAt: number;
  expiresAt: number;
}

// Environment Variables
export interface EnvConfig {
  port: number;
  nodeEnv: string;
  ollamaBaseUrl: string;
  ollamaModel: string;
  ollamaTimeout: number;
  apiKey: string;
  allowedOrigins: string[];
  redisUrl: string;
  logLevel: string;
  supabaseUrl?: string;
  supabaseKey?: string;  useHttps: boolean;
  sslKeyPath?: string;
  sslCertPath?: string;
}

// Baileys Session Types
export interface BaileysSession {
  businessId: string;
  sessionPath: string;
  isConnected: boolean;
  qrCode?: string;
  lastActivity?: number;
}

export interface BaileysMessage {
  from: string;
  message: string;
  timestamp: number;
  businessId: string;
  fromMe?: boolean;
}

// WebSocket Event Types
export type WebSocketEventType = 
  | 'qr_generated'
  | 'session_ready'
  | 'session_error'
  | 'session_disconnected'
  | 'message_received'
  | 'reservation_created'
  | 'reservation_updated'
  | 'zones_available';

export interface WebSocketEvent {
  type: WebSocketEventType;
  businessId: string;
  data: any;
  timestamp: number;
}

export interface QRGeneratedEvent {
  qrCode: string;
  businessId: string;
  expiresIn?: number;
}

export interface SessionReadyEvent {
  businessId: string;
  phoneNumber?: string;
  message: string;
}

export interface ReservationCreatedEvent {
  waitlistEntry: WaitlistEntry;
  customer: Customer;
  table?: Table;
  message: string;
}

// Reservation Flow Types
export interface ReservationDraft {
  conversationId: string;
  businessId: string;
  customerName?: string;
  partySize?: number;
  selectedZoneId?: string;
  step: 'name' | 'party_size' | 'zone_selection' | 'confirmation' | 'completed';
  createdAt: number;
  updatedAt: number;
}

export interface CreateReservationRequest {
  businessId: string;
  customerName: string;
  customerPhone: string;
  partySize: number;
  tableId?: string;
  zone?: string;
}

export interface CreateReservationResponse {
  success: boolean;
  waitlistEntry?: WaitlistEntry;
  error?: string;
}
